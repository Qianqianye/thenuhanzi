<html lang="en">
<head>
  <meta charset="utf-8">

  <title>The NÃ¼ Hanzi</title>
  <meta name="description" content="make your own hanzi">
  <meta name="author" content="xrw qqye">
  <script src="https://cdn.jsdelivr.net/npm/fabric@4.0.0-beta.7/dist/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <!-- <base href="https://xrwang.github.io/thenuhanzi/"> -->
  <script>
  /*
  ========
  section below deals with loading images dynamically
  =========

  */

  $(document).ready(function() {
    //need to fix relative path on github pages issue
    var folder = "./assets/SVG/";

    $.ajax({
    url : folder,
    success: function (data) {
          $(data).find("a").attr("href", function (i, val) {
          if( val.match(/\.(svg|png|gif)$/) ) {
              var string = "<img src='.." + val +"'>";
              $("#images").append( string );
              $("img").attr('draggable', 'true');

          }
      });
    }
    });
  });
  </script>
  <link rel="stylesheet" type="text/css" href="main.css">
</head>

<body>

    <div id="images">
    </div>

    <div id="canvas-container">
      <canvas id="canvas" width="800" height="500" style="border:3px solid red"></canvas>

    </div>

    <script type="text/javascript">


    /*
    ==============
    section below deals with draggin onto the canvas
    ==============
    */


    $(window).bind("load",function() {
      var canvas = new fabric.Canvas('canvas');


      var textbox = new fabric.Textbox('Drag above characters onto this canvas, double click me to type', {
        left:100,
        top: 100,
        width: 100,
        fontSize: 20
      });

      canvas.add(textbox).setActiveObject(textbox);


      var currentlyDragging;
      console.log('!!!!!!!!!!!!!')
      console.log(currentlyDragging)
      function handleDragStart(e) {
          [].forEach.call(images, function (img) {
              img.classList.remove('img_dragging');
          });
          console.log(e)

          this.classList.add('img_dragging');
          currentlyDragging = e.target;
      }

      function handleDragOver(e) {
          if (e.preventDefault) {
              e.preventDefault(); // Necessary. Allows us to drop.
          }
          e.dataTransfer.dropEffect = 'copy'; // See https://developer.mozilla.org/en-US/docs/Web/API/DataTransfer/dropEffect
          return false;
      }

      function handleDragEnter(e) {
        console.log(e)
          // this / e.target is the current hover target.
          this.classList.add('over');
      }

      function handleDragLeave(e) {
          this.classList.remove('over'); // this / e.target is previous target element.
      }

      function handleDrop(e) {
          if (e.preventDefault) {
            e.preventDefault();
          }

          if (e.stopPropagation) {
              e.stopPropagation(); // stops the browser from redirecting.
          }

          console.log('event: ', e);
          var ext = currentlyDragging.src.substr(-3);
          if (ext === 'svg') {
            fabric.loadSVGFromURL(currentlyDragging.src, function(objects, options) {
              var svg = fabric.util.groupSVGElements(objects, options);
              svg.left = e.layerX;
              svg.top = e.layerY;
              canvas.add(svg);
            });
          } else {
             var newImage = new fabric.Image(currentlyDragging, {
                width: currentlyDragging.width,
                height: currentlyDragging.height,
                // Set the center of the new object based on the event coordinates relative
                // to the canvas container.
                left: e.layerX,
                top: e.layerY
            });
            canvas.add(newImage);
          }
          return false;
      }

      function handleDragEnd(e) {
          // this/e.target is the source node.
          [].forEach.call(images, function (img) {
              img.classList.remove('img_dragging');
          });
      }

      if (Modernizr.draganddrop) {
          // Browser supports HTML5 DnD.

          // Bind the event listeners for the image elements
          var images = document.querySelectorAll('img');
          var objects = document.querySelectorAll('#images object');
          [].forEach.call(images, function (img) {
              img.addEventListener('dragstart', handleDragStart, false);
              img.addEventListener('dragend', handleDragEnd, false);
          });
          [].forEach.call(objects, function (obj) {
              obj.addEventListener('dragstart', handleDragStart, false);
              obj.addEventListener('dragend', handleDragEnd, false);
          });
          // Bind the event listeners for the canvas
          var canvasContainer = document.getElementById('canvas-container');
          canvasContainer.addEventListener('dragenter', handleDragEnter, false);
          canvasContainer.addEventListener('dragover', handleDragOver, false);
          canvasContainer.addEventListener('dragleave', handleDragLeave, false);
          canvasContainer.addEventListener('drop', handleDrop, false);
        } else {
            // Replace with a fallback to a library solution.
            alert("This browser doesn't support the HTML5 Drag and Drop API.");
        }
    });


      /*
      ==============
      Below is commented out, it loads *all of the characters* as svg and each of them become draggable
      ==============
      */
      // var canvas = new fabric.Canvas('canvas');
      //
      // var rect = new fabric.Rect({
      //   left: 100,
      //   top: 50,
      //   width: 100,
      //   height: 100,
      //   fill: 'green',
      //   angle: 20,
      //   padding: 10
      // });
      // canvas.add(rect);
      //
      //
      // fabric.loadSVGFromURL('../assets/test-2-radicals.svg', function(objects, options) {
      //   // var loadedObject = fabric.util.groupSVGElements(objects, options);
      //   console.log(objects)
      //   objects.forEach((item, i) => {
      //     canvas.add(item);
      //   });
      //
      //   canvas.renderAll();
      //
      // });

    </script>



</body>
</html>
